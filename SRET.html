<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SRET - Yes/No (Keyboard Only)</title>
  <style>
    :root {
      --bg: #d9d9d9;
      --fg: #111111;
      --barbg: #bdbdbd;
      --barfg: #2b2b2b;
    }
    html, body { height:100%; margin:0; font-family: Arial, Helvetica, sans-serif; background:var(--bg); color:var(--fg); }
    .wrap { height:100%; display:flex; align-items:center; justify-content:center; padding:24px; box-sizing:border-box; }
    .card { width:min(900px, 96vw); background:rgba(255,255,255,0.5); border:2px solid rgba(0,0,0,0.15); border-radius:18px; padding:34px; box-sizing:border-box; }

    .progressOuter {
      width: 100%;
      height: 16px;
      background: var(--barbg);
      border-radius: 999px;
      overflow: hidden;
      border: 2px solid rgba(0,0,0,0.15);
      margin-bottom: 26px;
    }
    .progressInner { height: 100%; width: 0%; background: var(--barfg); }

    h1 { margin:0 0 14px; font-size:34px; }
    p  { margin:12px 0; font-size:22px; line-height:1.4; }
    .center { text-align:center; }
    .stim { font-size:72px; font-weight:700; margin:26px 0 18px; }
    .fix  { font-size:92px; font-weight:700; margin:26px 0; }
    .kbd {
      display:inline-block;
      padding: 2px 10px;
      border-radius: 10px;
      border: 2px solid rgba(0,0,0,0.25);
      background: rgba(255,255,255,0.65);
      font-size: 20px;
      font-weight: 700;
    }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="screen-instructions">
      <h1>Task Instructions</h1>
      <p>
        You will see a series of traits. For each trait, decide if it describes you.
      </p>
      <p>
        <span class="kbd">V</span> = Yes &nbsp;&nbsp; <span class="kbd">N</span> = No
      </p>
      <p>
        Press <span class="kbd">Enter</span> to start.
      </p>
    </div>

    <div class="card hidden" id="screen-task">
      <div class="progressOuter" aria-label="progress bar">
        <div class="progressInner" id="progress-bar"></div>
      </div>

      <div class="center">
        <div id="stimulus" class="stim"></div>
        <div id="fixation" class="fix hidden">+</div>
      </div>
    </div>

    <div class="card hidden" id="screen-finish">
      <h1>You completed the Task!</h1>
      <p>Now you will be asked to complete a short set of questionnaires.</p>
      <p class="center" style="font-size:20px; margin-top:22px;">Please waitâ€¦</p>
    </div>
  </div>

  <script>
    // ----------------------------
    // Traits
    // ----------------------------
    const TRAITS = [
      "Affectionate","Caring","Communicative","Warm","Polite","Outgoing","Open","Loyal",
      "Sociable","Supportive","Sympathetic","Tolerant","Trustworthy","Understanding",
      "Altruistic","Fair","Friendly","Helpful","Honest","Considerate","Moral","Reliable",
      "Conscientious","Agreeable","Able","Ambitious","Assertive","Capable","Competent",
      "Active","Determined","Confident","Vigorous","Intelligent","Strong","Creative",
      "Persistent","Rational","Self-reliant","Independent","Industrious","Energetic",
      "Prominent","Successful","Leader","Influential","Charismatic","Enthusiastic"
    ];

    const FIXATION_MS = 500;

    // ----------------------------
    // Helpers
    // ----------------------------
    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function nowMs() { return performance.now(); }

    // ----------------------------
    // DOM
    // ----------------------------
    const scrInstr = document.getElementById("screen-instructions");
    const scrTask  = document.getElementById("screen-task");
    const scrDone  = document.getElementById("screen-finish");

    const stimEl   = document.getElementById("stimulus");
    const fixEl    = document.getElementById("fixation");
    const progBar  = document.getElementById("progress-bar");

    function show(screen) {
      scrInstr.classList.add("hidden");
      scrTask.classList.add("hidden");
      scrDone.classList.add("hidden");
      screen.classList.remove("hidden");
    }

    function renderStimulus(text) {
      stimEl.textContent = text;
      stimEl.classList.remove("hidden");
      fixEl.classList.add("hidden");
    }

    function renderFixation() {
      stimEl.classList.add("hidden");
      fixEl.classList.remove("hidden");
    }

    function setProgress(curIndex, total) {
      const pct = total ? (curIndex / total) * 100 : 0;
      progBar.style.width = pct + "%";
    }

    // ----------------------------
    // State / Logging
    // ----------------------------
    const sessionId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

    let trials = [];
    let tIndex = -1;

    let currentTrait = null;
    let stimOnsetMs = null;

    // Gate: only allow responses while stimulus is visible
    let acceptingResponse = false;

    const taskLog = {
      task: "SRET",
      version: "sret_v1_keyboard_only_enter_start_vn_yesno",
      session_id: sessionId,
      started_iso: null,
      finished_iso: null,
      n_trials: null,
      fixation_ms: FIXATION_MS,
      // Each entry logs ORDER OF PRESENTATION via trial_index / presentation_index
      trials: []
    };

    function startTask() {
      trials = shuffle(TRAITS);
      tIndex = -1;
      taskLog.started_iso = new Date().toISOString();
      taskLog.trials = [];

      show(scrTask);
      nextTrial();
    }

    function nextTrial() {
      tIndex += 1;
      setProgress(tIndex, trials.length);

      if (tIndex >= trials.length) {
        finishTask();
        return;
      }

      currentTrait = trials[tIndex];

      // Only now we allow responding
      acceptingResponse = true;

      renderStimulus(currentTrait);
      stimOnsetMs = nowMs();
    }

    function recordResponse(resp) {
      if (!acceptingResponse) return;

      // close gate immediately so no double keypress
      acceptingResponse = false;

      const rtMs = Math.round(nowMs() - stimOnsetMs);

      taskLog.trials.push({
        // order of presentation (1..N)
        trial_index: tIndex + 1,
        presentation_index: tIndex + 1,

        trait: currentTrait,
        response: resp,     // "Yes" / "No"
        rt_ms: rtMs,

        // helpful metadata
        trait_onset_ms: Math.round(stimOnsetMs),
        response_time_iso: new Date().toISOString()
      });

      // hide word and show fixation during ISI
      renderFixation();

      // During fixation, responses are blocked (acceptingResponse = false)
      window.setTimeout(() => nextTrial(), FIXATION_MS);
    }

    function finishTask() {
      taskLog.finished_iso = new Date().toISOString();
      taskLog.n_trials = trials.length;

      show(scrDone);

      // Send to Qualtrics
      window.parent.postMessage(
        { type: "SRET_Log_v1", taskLog: taskLog },
        "*"
      );
    }

    // ----------------------------
    // Keyboard only
    // ----------------------------
    let hasStarted = false;

    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();

      // Prevent accidental scrolling/space behavior
      if (k === " " || k === "spacebar") e.preventDefault();

      // Start only on instructions screen: Enter
      if (!hasStarted) {
        if (!scrInstr.classList.contains("hidden") && e.key === "Enter") {
          hasStarted = true;
          startTask();
        }
        return;
      }

      // During task: only accept while stimulus is visible
      if (scrTask.classList.contains("hidden")) return;
      if (!acceptingResponse) return;

      if (k === "v") recordResponse("Yes");
      else if (k === "n") recordResponse("No");
    }, { passive: false });

    // Initial
    show(scrInstr);

    // Extra hard block for mouse interaction (optional)
    document.addEventListener("click", function (e) {
      // No clicks do anything; prevents accidental focus/clicks
      e.preventDefault();
    }, true);
  </script>
</body>
</html>
